<% layout("/layouts/boilerplate") %>

    <div class="container my-4">

        <!-- ================= TOP SECTION ================= -->
        <div class="row gx-5">

            <!-- LEFT COLUMN -->
            <div class="col-lg-7 col-md-12">

                <!-- Title + Host -->
                <h3 class="mb-1">
                    <%= listing.title %>
                </h3>
                <p class="text-muted mb-3">
                    Hosted by <b>@<%= listing.owner.username %></b>
                </p>

                <!-- Image -->
                <div class="card mb-4">
                    <img src="<%= listing.image.url %>" class="card-img-top"
                        style="max-height: 420px; object-fit: cover;" alt="Listing Image">
                </div>

                <!-- About -->
                <h5>About this place</h5>
                <p>
                    <%= listing.description %>
                </p>
                <hr>

                <h5 class="mb-3">What this place offers</h5>

                <div class="row amenities-grid">
                    <% listing.amenities.forEach(a=> { %>
                        <div class="col-md-6 mb-3">
                            <div class="amenity-item">
                                <i class="fa-solid fa-check text-success me-2"></i>
                                <span>
                                    <%= a %>
                                </span>
                            </div>
                        </div>
                        <% }) %>
                </div>


                <br><br>

                <!-- Owner buttons -->
                <% if(currUser && listing.owner._id.equals(currUser._id)) { %>
                    <div class="d-flex gap-2 mb-4">
                        <a href="/listings/<%= listing._id %>/edit" class="btn btn-dark btn-sm">
                            Edit Listing
                        </a>
                        <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE">
                            <button class="btn btn-outline-dark btn-sm">Delete</button>
                        </form>
                    </div>
                    <% } %>


            </div>
            <!-- RIGHT COLUMN -->
            <div class="col-lg-4 col-md-12 ms-lg-5">

                <div class="card shadow-lg p-4 reservation-card  ">

                    <!-- Price -->
                    <h4 class="mb-1">
                        &#8377; <%= listing.price.toLocaleString("en-IN") %> / night
                    </h4>

                    <p class="text-muted small mb-3">
                        Highly rated · Great location
                    </p>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">Check-in</label>
                        <input type="date" class="form-control" name="checkin" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">Check-out</label>
                        <input type="date" class="form-control" name="checkout" required>
                    </div>


                    <!-- Reserve -->
                    <button class="btn btn-danger w-100 mb-4">
                        Reserve
                    </button>

                    <!-- DETAILS -->
                    <div class="mb-3">

                        <p class="mb-2">
                            <i class="fa-solid fa-calendar-check text-success me-2"></i>
                            Available slots
                        </p>

                        <p class="mb-2">
                            <i class="fa-solid fa-lock text-primary me-2"></i>
                            Secure payments
                        </p>

                        <p class="mb-2">
                            <i class="fa-solid fa-ban text-warning me-2"></i>
                            Free cancellation
                        </p>

                        <p class="mb-2">
                            <i class="fa-solid fa-shield-halved text-dark me-2"></i>
                            Verified host
                        </p>

                        <p class="mb-0">
                            <i class="fa-solid fa-circle-check text-success me-2"></i>
                            Book instantly
                        </p>

                    </div>
                </div><br><br>

                <!-- ================= MAP ================= -->
                <div class="card shadow-sm p-3 map-card">
                    <h6 class="mb-1"><b>Where you’ll be</b></h6>
                    <span class="text-muted">
                        <i class="fa-solid fa-location-dot "></i>
                        <b><%= listing.location %>, <%= listing.country %></b>
                    </span>
                    <div id="map" class="listing-map mt-1" data-lat="<%= listing.geometry.coordinates[1] %>"
                        data-lng="<%= listing.geometry.coordinates[0] %>" data-title="<%= listing.title %>"
                        data-location="<%= listing.location %>">
                    </div>
                </div>

            </div>
        </div>

        <!-- ================= REVIEWS SECTION ================= -->
        <hr class="my-4">

        <div class="row">

            <!-- leftT: LEAVE REVIEW -->
            <div class="col-lg-7 col-md-12">
                <h4>Leave a Review</h4>

                <form method="POST" action="/listings/<%= listing._id %>/reviews" class="card p-4 shadow-sm mb-4">

                    <fieldset class="starability-slot">
                        <input type="radio" id="rate1" name="review[rating]" value="1" required />
                        <label for="rate1">1</label>

                        <input type="radio" id="rate2" name="review[rating]" value="2" />
                        <label for="rate2">2</label>

                        <input type="radio" id="rate3" name="review[rating]" value="3" />
                        <label for="rate3">3</label>

                        <input type="radio" id="rate4" name="review[rating]" value="4" />
                        <label for="rate4">4</label>

                        <input type="radio" id="rate5" name="review[rating]" value="5" />
                        <label for="rate5">5</label>
                    </fieldset>


                    <textarea name="review[comment]" class="form-control review-textarea mb-2" rows="2"
                        placeholder="Share your experience" required></textarea>

                    <div class="text-start">
                        <button class="btn btn-dark btn-sm px-4">
                            Submit
                        </button>
                    </div>
                </form>
            </div>
            <!-- rigthT: HOST INFO -->
            <div class="col-lg-4 col-md-12 ms-lg-5">
                <h4>Meet your host</h4>
                <div class="card p-3 shadow-sm">
                    <div class="d-flex align-items-center gap-3">
                        <img src="https://ui-avatars.com/api/?name=<%= listing.owner.username %>&background=E83E8C&color=fff"
                            class="rounded-circle" width="70" height="70" alt="Host Avatar">
                        <div>
                            <h5 class="mb-0">
                                <%= listing.owner.username %>
                            </h5>
                            <small class="text-muted">Host</small>
                            <br>
                            <div class="text-success fw-semibold">✔ Verified Host</div>

                            <small class="text-muted d-block">
                                Member since <%= new Date(listing.owner.createdAt).getFullYear() %>
                            </small>
                        </div>
                    </div>

                    <a href="/users/<%= listing.owner._id %>/contact?listingId=<%= listing._id %>"
                        class="btn btn-outline-primary mt-4 mb-3">
                        Contact Host
                    </a>

                </div>
            </div>

        </div>

        <!-- ================= ALL REVIEWS BELOW ================= -->

        <% if(listing.reviews.length) { %>
            <hr class="my-4">
            <h4 class="mb-4 ">All Reviews</h4>

            <div class="row">
                <% listing.reviews.forEach(review=> { %>
                    <div class="col-lg-4 col-md-6 col-12 mb-3">
                        <div class="card h-100 shadow-sm">
                            <div class="card-body p-3">

                                <h6 class="mb-1">@<%= review.author.username %>
                                </h6>

                                <p class="starability-result mb-2" data-rating="<%= review.rating %>"></p>

                                <p class="small text-muted">
                                    <%= review.comment %>
                                </p>

                                <% if(currUser && review.author._id.equals(currUser._id)) { %>
                                    <form method="POST"
                                        action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE">
                                        <button class="btn btn-sm btn-outline-danger">
                                            Delete
                                        </button>
                                    </form>
                                    <% } %>

                            </div>
                        </div>
                    </div>
                    <% }) %>
            </div>
            <% } %>
            <hr>
                <section class="things-to-know mb-5">
                    <h3 class="mb-4 ">Things to know</h3>

                    <div class="row gy-4">

                        <!-- Cancellation policy -->
                        <div class="col-md-4">
                            <div class="d-flex gap-3">
                                <i class="bi bi-calendar-x fs-4"></i>
                                <div>
                                    <h6 class="fw-semibold mb-1">Cancellation policy</h6>
                                    <p class="text-muted small mb-1">
                                        Free cancellation before 16 February.
                                        Cancel before check-in on 17 February for a partial refund.
                                    </p>
                                    <a href="#" class="small text-decoration-underline">Learn more</a>
                                </div>
                            </div>
                        </div>

                        <!-- House rules -->
                        <div class="col-md-4">
                            <div class="d-flex gap-3">
                                <i class="bi bi-key fs-4"></i>
                                <div>
                                    <h6 class="fw-semibold mb-1">House rules</h6>
                                    <p class="text-muted small mb-1">
                                        Check-in after 1:00 PM <br>
                                        Checkout before 10:00 AM <br>
                                        4 guests maximum
                                    </p>
                                    <a href="#" class="small text-decoration-underline">Learn more</a>
                                </div>
                            </div>
                        </div>

                        <!-- Safety & property -->
                        <div class="col-md-4">
                            <div class="d-flex gap-3">
                                <i class="bi bi-shield-check fs-4"></i>
                                <div>
                                    <h6 class="fw-semibold mb-1">Safety & property</h6>
                                    <p class="text-muted small mb-1">
                                        Carbon monoxide alarm not reported <br>
                                        Smoke alarm not reported <br>
                                        Exterior security cameras on property
                                    </p>
                                    <a href="#" class="small text-decoration-underline">Learn more</a>
                                </div>
                            </div>
                        </div>

                    </div>
                </section>

    </div>